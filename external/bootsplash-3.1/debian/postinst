#! /bin/bash
# postinst script for bootsplash
#
# see: dh_installdeb(1)

set -e

THEME_SYMLINK="/etc/bootsplash/themes/current"

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#

case "$1" in
    configure)

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac


# Update grub's menu.lst so it can show the splash when booting
if [ -f /boot/grub/menu.lst ] ;then
        # Remove the bootsplash options if it exists
        if grep -q "^# altoptions=(bootsplash)" /boot/grub/menu.lst ;then
                remove=$(grep "^# altoptions=(bootsplash)" /boot/grub/menu.lst)
                sed "s~$remove~~g" /boot/grub/menu.lst > /boot/grub/menu.lst.awk
                mv /boot/grub/menu.lst.awk /boot/grub/menu.lst
                update-grub
        fi

        # Add a nosplash option if it doesn't exits
        if ! grep -q "altoptions=(nosplash)" /boot/grub/menu.lst ;then
                insertTo=$(grep -n "^## e.g. altopt" /boot/grub/menu.lst | cut -d':' -f1)
                insertTo=$(($insertTo + 1))
                awk "{print} NR == $insertTo {print \"# altoptions=(nosplash) vga=normal\"}" /boot/grub/menu.lst > /boot/grub/menu.lst.awk
                mv /boot/grub/menu.lst.awk /boot/grub/menu.lst
                update-grub
        fi

	# Add the quiet option by default
	if ! grep -q "^# kopt=.* quiet" /boot/grub/menu.lst ;then
		oldKopt=$(grep "^# kopt=.*" /boot/grub/menu.lst)
		newKopt="$oldKopt quiet"
		sed "s~$oldKopt~$newKopt~g" /boot/grub/menu.lst > /boot/grub/menu.lst.sed
                mv /boot/grub/menu.lst.sed /boot/grub/menu.lst
                update-grub
	fi

        # Add the splash option by default
        if ! grep -q "^# kopt=.* splash=silent" /boot/grub/menu.lst ;then
                oldKopt=$(grep "^# kopt=.*" /boot/grub/menu.lst)
                newKopt="$oldKopt splash=silent"
                sed "s~$oldKopt~$newKopt~g" /boot/grub/menu.lst > /boot/grub/menu.lst.sed
                mv /boot/grub/menu.lst.sed /boot/grub/menu.lst
                update-grub
        fi

        # Add the vga option by default
        if ! grep -q "^# kopt=.* vga=0x311" /boot/grub/menu.lst ;then
                oldKopt=$(grep "^# kopt=.*" /boot/grub/menu.lst)
                newKopt="$oldKopt vga=0x311"
                sed "s~$oldKopt~$newKopt~g" /boot/grub/menu.lst > /boot/grub/menu.lst.sed
                mv /boot/grub/menu.lst.sed /boot/grub/menu.lst
                update-grub
        fi

        # Remove duplicate vga=0x311 vga=normal (hack because no noaltoptions)
        if grep -q "^.*vga=0x311 vga=normal.*$" /boot/grub/menu.lst ;then
                sed "s~vga=0x311 vga=normal~vga=normal~g" /boot/grub/menu.lst > /boot/grub/menu.lst.sed
                mv /boot/grub/menu.lst.sed /boot/grub/menu.lst
        fi

fi

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
