Add caching
Remove unused pthread code
