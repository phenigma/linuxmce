#!/bin/bash

set -e 

. ./filesd-parms.sh $@

. /usr/pluto/bin/Network_Parameters.sh
. /usr/pluto/bin/Section_Ops.sh
. /usr/pluto/bin/Utils.sh

## Config for nis to act as a client
File="/etc/default/nis"
mkdir -p "${Parm_RootLocation}/$(dirname $File)"
cp "/usr/pluto/templates/nis-client.template" "${Parm_RootLocation}/${File}"
PopulateSection "${Parm_RootLocation}/${File}" "Nis Master" "NISMASTER=$IntIP"

## Set the default nis domain
File="/etc/defaultdomain"
mkdir -p "${Parm_RootLocation}/$(dirname $File)"
echo "pluto" > "${Parm_RootLocation}/${File}"

## Let the client know who is the server
File="/etc/yp.conf"
mkdir -p "${Parm_RootLocation}/$(dirname $File)"
echo "ypserver ${IntIP}" > "${Parm_RootLocation}/${File}"
echo "ypserver ${IntIP}" > ${File}

## Configure nsswitch file
File="/etc/nsswitch.conf"
mkdir -p "${Parm_RootLocation}/$(dirname $File)"
Content="
passwd:         compat
group:          compat
shadow:         compat

hosts:          files nis dns
networks:       files

protocols:      db files
services:       db files
ethers:         db files
rpc:            db files

netgroup:       nis
"
echo "$Content" > "${Parm_RootLocation}/${File}"


if [ ! -e ${Parm_RootLocation}/etc/group.pbackup ] ;then
   cp ${Parm_RootLocation}/etc/group ${Parm_RootLocation}/etc/group.pbackup 2>/dev/null || :
fi

if [ ! -e ${Parm_RootLocation}/etc/passwd.pbackup ] ;then
   cp ${Parm_RootLocation}/etc/passwd ${Parm_RootLocation}/etc/passwd.pbackup 2>/dev/null || :
fi

if [ ! -e ${Parm_RootLocation}/etc/shadow.pbackup ] ;then
   cp ${Parm_RootLocation}/etc/shadow ${Parm_RootLocation}/etc/shadow.pbackup 2>/dev/null || :
fi

## Force a diskless client to get passwd/shadow & group from nis
if [[ -f ${Parm_RootLocation}/etc/passwd ]] && ! BlacklistConfFiles "${Parm_RootLocation}/etc/passwd" ;then
	grep -q "+::::::"   ${Parm_RootLocation}/etc/passwd || echo "+::::::"   >> ${Parm_RootLocation}/etc/passwd
	sed -ir '/.*:.*:[0-9]{4}:.*/d' ${Parm_RootLocation}/etc/passwd
fi
if [[ -f ${Parm_RootLocation}/etc/shadow ]] &&  ! BlacklistConfFiles "${Parm_RootLocation}/etc/shadow" ;then
	grep -q "+::::::::" ${Parm_RootLocation}/etc/shadow || echo "+::::::::" >> ${Parm_RootLocation}/etc/shadow
fi

if [[ -f ${Parm_RootLocation}/etc/group ]] &&  ! BlacklistConfFiles "${Parm_RootLocation}/etc/group" ;then
	grep -q "+:::"      ${Parm_RootLocation}/etc/group  || echo "+:::"      >> ${Parm_RootLocation}/etc/group
fi

